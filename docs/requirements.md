# 没入型翻訳 Chrome拡張機能 — 要件定義書

## 概要

[Immersive Translate](https://immersivetranslate.com/) の核心機能を再現するChrome拡張機能を開発する。
**最大の特徴**: 原文（英語）を残したまま、その直下に翻訳文（日本語）をインライン表示する「バイリンガル表示」方式。

翻訳エンジンは **Google翻訳（無料API）** を使用する。

---

## コア要件

### 1. バイリンガル翻訳表示

| 項目           | 仕様                                                                                        |
| -------------- | ------------------------------------------------------------------------------------------- |
| 翻訳方向       | 英語 → 日本語（初期）                                                                       |
| 表示方式       | 原文の段落/要素の直下に翻訳文を挿入                                                         |
| 翻訳単位       | `<p>`, `<h1>`〜`<h6>`, `<li>`, `<td>`, `<th>`, `<blockquote>`, `<caption>` 等のブロック要素 |
| 翻訳文スタイル | 薄い背景色 + やや小さいフォントで原文と区別                                                 |
| 除外対象       | `<code>`, `<pre>`, `<script>`, `<style>`, `<input>`, `<textarea>`, ナビゲーション要素       |

#### 表示イメージ

```
┌─────────────────────────────────────┐
│ This is the original English text.  │  ← 原文（そのまま）
│ これは元の英語テキストです。          │  ← 翻訳文（挿入）
├─────────────────────────────────────┤
│ Another paragraph follows here.     │
│ ここに別の段落が続きます。            │
└─────────────────────────────────────┘
```

### 2. 翻訳トリガー

| トリガー                   | 動作                         |
| -------------------------- | ---------------------------- |
| ツールバーアイコンクリック | 現在のページ全体を翻訳       |
| ショートカットキー         | `Alt+T` でページ翻訳のトグル |
| Popupボタン                | 「このページを翻訳」ボタン   |

### 3. 翻訳エンジン（Google翻訳）

- Google翻訳の無料エンドポイント（`translate.googleapis.com`）を使用
- APIキー不要の方式で初期実装
- 翻訳リクエストは段落単位でバッチ処理（レート制限対策）

### 4. Popup UI

- 翻訳ON/OFFトグル
- 翻訳状態の表示（翻訳中 / 完了 / エラー）
- 翻訳対象の言語ペア表示

---

## 追加提案機能

### Phase 2（実装推奨）

| 機能                 | 説明                                                           |
| -------------------- | -------------------------------------------------------------- |
| **選択テキスト翻訳** | テキスト選択時にポップオーバーで翻訳表示                       |
| **翻訳キャッシュ**   | 翻訳結果を`chrome.storage`にキャッシュして再アクセス時の高速化 |
| **サイト別設定**     | 特定サイトでの自動翻訳ON/OFF                                   |
| **翻訳文の表示切替** | 翻訳文のみ / 原文のみ / 両方表示の切替                         |

### Phase 3（将来拡張）

| 機能                   | 説明                           |
| ---------------------- | ------------------------------ |
| **翻訳エンジン切替**   | DeepL、OpenAI等の追加対応      |
| **多言語対応**         | 英語以外の言語からの翻訳       |
| **PDF翻訳**            | PDF閲覧時のバイリンガル表示    |
| **右クリックメニュー** | コンテキストメニューから翻訳   |
| **翻訳品質比較**       | 複数エンジンの結果を並べて比較 |

---

## 技術仕様

### アーキテクチャ

```
Popup UI → (メッセージング) → Service Worker → (メッセージング) → Content Script → DOM操作
                                    ↓
                              Google翻訳API
                              chrome.storage
```

### Manifest V3 構成

```
translation/
├── manifest.json
├── background.js          # Service Worker: API通信・メッセージング
├── content.js             # Content Script: DOM解析・翻訳文挿入
├── content.css            # 翻訳文のスタイル
├── popup/
│   ├── popup.html
│   ├── popup.js
│   └── popup.css
├── icons/
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
└── lib/
    └── translator.js      # Google翻訳APIクライアント
```

### permissions

```json
{
  "permissions": ["storage", "activeTab"],
  "host_permissions": ["https://translate.googleapis.com/*"]
}
```

### 翻訳処理フロー

1. ユーザーが翻訳を開始（Popup / ショートカット）
2. Service Worker → Content Script に翻訳指示を送信
3. Content Script がページのテキストノードを走査し、翻訳対象ブロックを抽出
4. 抽出テキストを Service Worker に送信
5. Service Worker が Google翻訳APIに一括リクエスト（バッチ分割）
6. 翻訳結果を Content Script に返却
7. Content Script が各ブロックの直下に翻訳文要素を挿入

### 翻訳文のDOM構造

```html
<!-- 原文要素 -->
<p>This is the original text.</p>
<!-- 挿入される翻訳文 -->
<p class="immersive-translate-result" data-source="google">
  これは元のテキストです。
</p>
```

---

## 非機能要件

| 項目           | 要件                                                           |
| -------------- | -------------------------------------------------------------- |
| パフォーマンス | 翻訳リクエストは500文字ごとにバッチ化、並列度は最大3リクエスト |
| レート制限     | リクエスト間に200msのディレイを挿入                            |
| エラー処理     | API失敗時のリトライ（最大3回、指数バックオフ）                 |
| セキュリティ   | CSP準拠、`textContent`使用、XSS防止                            |
| UX             | 翻訳中のローディング表示、段階的な翻訳表示（上から順に）       |

---

## 実装フェーズ

### Phase 1: MVP（今回実装）
- [ ] manifest.json / プロジェクト構成
- [ ] Content Script（テキスト抽出 + 翻訳文挿入）
- [ ] Service Worker（Google翻訳APIクライアント）
- [ ] Popup UI（翻訳トリガーボタン）
- [ ] 翻訳文のスタイリング
- [ ] アイコン生成

### Phase 2: 拡張機能
- [ ] 選択テキスト翻訳
- [ ] 翻訳キャッシュ
- [ ] サイト別自動翻訳設定
- [ ] 表示モード切替

---

## 検証計画

### ブラウザテスト

1. Chrome に拡張機能を読み込み（`chrome://extensions/` → デベロッパーモード）
2. 英語のWebページ（例: [news.ycombinator.com](https://news.ycombinator.com)）を開く
3. 拡張機能アイコンをクリックし、「翻訳」ボタンを押す
4. 以下を確認:
   - 原文が残っている
   - 各段落の直下に日本語翻訳が表示される
   - 翻訳文が視覚的に区別可能（背景色・フォントサイズ）
   - `<code>`, `<pre>` 等は翻訳されない
5. 再度クリックで翻訳をOFFにし、翻訳文が除去されることを確認

### 手動検証項目

| テスト項目             | 期待結果                            |
| ---------------------- | ----------------------------------- |
| Popup「翻訳」ボタン    | ページ全体が翻訳される              |
| `Alt+T` ショートカット | 翻訳のトグル                        |
| コード要素             | `<pre>`, `<code>` は翻訳されない    |
| 長文ページ             | 段階的に翻訳が表示される            |
| 翻訳OFF                | 翻訳文がすべて除去される            |
| エラー時               | エラーメッセージがPopupに表示される |
